<div class="app" id="view-sealing">
    <section style="text-align:center; padding-top:120px;">
        <div class="logo">AUTHENTICATION</div>
        <div class="formula-hero" id="seal-txt">데이터 봉인 준비 중...</div>
        <button id="btn-send" class="btn-main" style="display:none; margin-top:60px;" onclick="sendKey()">그녀에게 열쇠 보내기 →</button>
    </section>
</div>

<div class="app" id="view-report">
    <section id="report-content">
        <div style="text-align: center; margin-bottom: 40px;">
            <div class="logo">THE FINAL BLUEPRINT</div>
            <h2>내면의 영혼 리포트</h2>
        </div>
        <div class="pillar-card"><canvas id="radar"></canvas></div>
        <div id="p1-res"></div><div id="p2-res"></div><div id="p3-res"></div>
        <div class="pillar-card" style="margin-top:40px; text-align:center;">
            <span style="color: var(--accent); font-weight: 800; font-size: 0.95rem; letter-spacing:3px;">FINAL ENGINE</span>
            <div style="background:#000; padding:20px; border-radius:15px; margin:20px 0; border:1px solid var(--border);">
                $$EV_{Index} = \oint_{t=0}^{24} \left( \frac{\sum S_i \cdot W_i}{\sigma(Environment)} \right) dt$$
            </div>
            <p class="p-body">의장님, 이 리포트는 9해 3132경 가지의 확률을 뚫고 포착한 유일한 정서적 주파수예요.</p>
        </div>
    </section>
    <footer>© SYNAPSE ON.</footer>
</div>

<script>
    function switchView(id) {
        document.querySelectorAll('.app').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0); if(window.MathJax) MathJax.typeset();
    }
    function copyInviteLink() {
        const url = window.location.origin + window.location.pathname + "?mode=user";
        const t = document.createElement("textarea"); document.body.appendChild(t); t.value = url; t.select(); document.execCommand("copy"); document.body.removeChild(t);
        alert("남자친구 초대 링크가 복사되었어요! 카톡에 전달해 주세요.");
    }
    function setRel(type, btn) {
        relation = type; document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
    }
    function startSurvey() { switchView('view-survey'); renderQ(); }
    function renderQ() {
        const q = DB[step]; const box = document.getElementById('view-survey');
        box.innerHTML = `<section><div class="progress-ui">SYNAPSE ${step+1}/30</div><div class="pillar-card"><div class="q-text">${q.q}</div><div id="opts"></div></div></section>`;
        q.opts.forEach((o, i) => {
            const b = document.createElement('button'); b.className = 'opt-btn'; b.innerText = o;
            b.onclick = () => { answers.push(i); step++; 
                if(step === 15) switchView('view-bridge');
                else if(step < 30) renderQ(); 
                else { switchView('view-sealing'); runSeal(); }
            };
            document.getElementById('opts').appendChild(b);
        });
    }
    function runSeal() {
        let p = 0; const txt = document.getElementById('seal-txt');
        const iv = setInterval(() => { p += 5; txt.innerText = `영혼 봉인 중... ${p}%`;
            if(p >= 100) { clearInterval(iv); document.getElementById('btn-send').style.display='block'; }
        }, 100);
    }
    function sendKey() {
        const url = window.location.origin + window.location.pathname + "?res=" + answers.join(',') + "&rel=" + relation;
        const t = document.createElement("textarea"); document.body.appendChild(t); t.value = url; t.select(); document.execCommand("copy"); document.body.removeChild(t);
        alert("그녀에게 보낼 열쇠가 복사되었어요! 카톡에 전달해 주세요.");
    }
    function renderReport() {
        const p1 = document.getElementById('p1-res'); const p2 = document.getElementById('p2-res'); const p3 = document.getElementById('p3-res');
        DB.forEach((item, i) => {
            let txt = item.res[answers[i]]; if(relation === 'lover') txt = txt.replace(/당신/g, "그").replace(/상대/g, "당신");
            const h = `<div class="r-item"><b>ITEM ${i+1}. ${item.tag}</b><p>${txt}</p></div>`;
            if(i < 10) p1.innerHTML += h; else if(i < 20) p2.innerHTML += h; else p3.innerHTML += h;
        });
        new Chart(document.getElementById('radar'), {
            type: 'radar', data: { labels: ['주동성', '방어기제', '공명도', '안정기지', '응집력'], datasets: [{ data: [85, 72, 90, 68, 88], borderColor: '#00f2ff', backgroundColor: 'rgba(0, 242, 255, 0.2)' }] },
            options: { scales: { r: { grid: { color: '#2d2d3d' }, ticks: { display: false }, min: 0, max: 100 } }, plugins: { legend: { display: false } } }
        });
    }
    window.onload = () => {
        const p = new URLSearchParams(window.location.search);
        if(p.get('res')) { answers = p.get('res').split(',').map(Number); relation = p.get('rel'); switchView('view-report'); renderReport(); }
        else if(p.get('mode') === 'user') { switchView('view-user-landing'); }
    };
</script>
</body>
</html>
